#!/bin/bash

# Prompt for source table name
echo -n "Enter the source table name (schema.table): "
read source_table

# Validate input
if [ -z "$source_table" ]; then
    echo "Table name cannot be empty."
    exit 1
fi

# Define new table name
new_table="${source_table}_new_"

# Create the Iceberg table with partitions
impala-shell -i usvxapinscs08.sdi.corp.bankofamerica.com:21000 --ssl -q "
CREATE TABLE $new_table (
    sale_id INT,
    product_name STRING,
    sale_amount DOUBLE
)
PARTITIONED BY (region STRING, year INT, month INT)
STORED AS ICEBERG
TBLPROPERTIES (
    'format-version' = '2',
    'parquet_annotate_strings_utf8' = 'true'
);
"

# Insert data into the new table
impala-shell -i usvxapinscs08.sdi.corp.bankofamerica.com:21000 --ssl -q "
INSERT INTO $new_table
PARTITION (region, year, month)
SELECT sale_id, product_name, sale_amount, region, year, month
FROM $source_table;
"

if [ $? -eq 0 ]; then
    echo "Table $new_table created successfully with partitions and data loaded."
else
    echo "Failed to create the new table or load data."
    exit 1
fi
