#!/bin/bash

# Variables for source and target
source="iceberg_migration_table"
source_db="smoke_test"
target_db="smoke_test"
target="${source}_new"
version="2"

# Bucketing and partitioning configuration
bucket_cols="region"
num_buckets=10
bucket_string="bucket(${num_buckets},${bucket_cols})"

# Step 1: Generate the Iceberg-compatible schema
impala-shell -i uszvapinscs08.sdi.corp.bankofamerica.com:21000 --ssl -B -q \
"SHOW CREATE TABLE ${source_db}.${source}" | \
sed "s/${source}/${target}/g" | \
sed "s/PARQUET/ICEBERG/g" | \
sed "s/'//g" | \
sed "s/EXTERNAL//g" | \
sed "s/TBLPROPERTIES (/TBLPROPERTIES (\n  'version'='${version}',/" | \
sed "s/PARTITIONED BY (/PARTITIONED BY (${bucket_string},/" > data.sql

# Step 2: Execute the modified schema to create the Iceberg table
impala-shell -i uszvapinscs08.sdi.corp.bankofamerica.com:21000 --ssl -f data.sql

# Step 3: Migrate data to the Iceberg table
impala-shell -i uszvapinscs08.sdi.corp.bankofamerica.com:21000 --ssl -B -q \
"INSERT INTO TABLE ${target_db}.${target} SELECT * FROM ${source_db}.${source};"

echo "Migration to Iceberg completed successfully."
